name: Zero Downtime Deploy + Report

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Git pull
        run: |
          cd /home/deploy/apps/node-app
          git pull

      - name: Show git changes (FILES)
        run: |
          cd /home/deploy/apps/node-app
          echo "===== CHANGED FILES ====="
          git show --stat --oneline -1

      - name: Project size (MB)
        run: |
          cd /home/deploy/apps/node-app
          echo "===== PROJECT SIZE ====="
          du -sh .

      - name: Build images
        run: |
          cd /home/deploy/apps/node-app
          docker compose build

      - name: Start containers (blue + green)
        run: |
          cd /home/deploy/apps/node-app
          docker compose up -d

      - name: Switch traffic (zero-downtime)
        run: |
          /home/deploy/apps/node-app/switch.sh

